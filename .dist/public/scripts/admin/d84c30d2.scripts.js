"use strict";angular.module("admin",["ngRoute","ui.bootstrap","bbc.transport","bbc.navigation","bbc.cache","bbc.form","bbc.modal","bbc.pager","bbc.sort","bbc.session","common.auth","pascalprecht.translate","tmh.dynamicLocale","checklist-model","admin.groups","admin.rights","admin.roles","admin.users"]).config(["$routeProvider","$locationProvider","$bbcNavigationProvider","$translateProvider","$bbcTransportProvider","tmhDynamicLocaleProvider",function(a,b,c,d,e,f){a.otherwise({redirectTo:"/admin/users"}),b.html5Mode(!0),c.set({app:"admin",route:"/admin"}),e.set(),f.localeLocationPattern("assets/bower_components/angular-i18n/angular-locale_{{locale}}.js"),d.useStaticFilesLoader({prefix:"/locale/admin/locale-",suffix:".json"}),d.preferredLanguage("en-us"),d.fallbackLanguage("en-us")}]).constant("adminModulePath","api/app/admin/").run(["$rootScope","$translate","tmhDynamicLocale","$log","$window","$bbcSession",function(a,b,c,d,e,f){a.currentLang=b.preferredLanguage(),a.switchLocale=function(c){b.use(c),a.currentLang=c},a.requestNeeded=!1,a.$on("$routeChangeStart",function(b,c){f.setActivity(function(b){b&&(d.warn(b),a.$emit("$sessionInactive"))}),a.requestNeeded&&e.location.assign(c.$$route.originalPath)}),a.$on("$sessionInactive",function(){d.warn("next route change event triggers a server request."),a.requestNeeded=!0}),a.$on("$translateChangeSuccess",function(){c.set(b.use())})}]),angular.module("admin.groups",[]).config(["$routeProvider",function(a){a.when("/admin/groups",{templateUrl:"app/admin/groups/groups.html",controller:"AdminGroupListCtrl"}),a.when("/admin/groups/edit/:id",{templateUrl:"app/admin/groups/editGroup.html",controller:"AdminEditGroupCtrl"}),a.when("/admin/groups/new",{templateUrl:"app/admin/groups/editGroup.html",controller:"AdminEditGroupCtrl"})}]).controller("AdminGroupListCtrl",["$rootScope","$scope","adminModulePath","$bbcTransport","$bbcModal","$translate",function(a,b,c,d,e,f){b.initialPageSize=10,b.pagingOptions={skip:0,limit:b.initialPageSize},b.sortOpts={name:1};var g="DEL",h="DEL",i={yes:"Y",no:"N"};a.$on("$translateChangeSuccess",function(){j()});var j=function(){f(["DELETE","DELETE_MSG","YES","NO"]).then(function(a){g=a.DELETE,h=a.DELETE_MSG,i.yes=a.YES,i.no=a.NO})},k=function(){var a={options:b.pagingOptions};a.options.sort=b.sortOpts,a.options.fields=["_id","name","description"],d.emit(c+"groups/groups/getAll",a,function(a,c){c&&(b.groups=c.items,b.count=c.count)})};j(),b.load=function(a,c){b.pagingOptions=c,b.sortOpts=a,k()},b.closeAlert=function(a){b.alerts.splice(a,1)},b.alerts=[],b.remove=function(a){b.alerts.length=0;var f={id:"deleteGroup",message:h,headline:g,backdrop:!0,buttonTextValues:i};f.callObj={cbYes:function(){d.emit(c+"groups/groups/remove",{id:a},function(a){a?"ControllerError"===a.name?b.alerts.push({type:"danger",msg:a.message}):b.alerts.push({type:"danger",msg:"GENERIC_ERROR"}):k()})},cbNo:function(){}},e.open(f)},k()}]).controller("AdminEditGroupCtrl",["$scope","$routeParams","$location","$bbcForm","adminModulePath","$bbcTransport",function(a,b,c,d,e,f){a.bbcForm=d("baboon_group","_id"),b.id&&!a.bbcForm.hasLoadedModelFromCache(b.id)&&f.emit(e+"groups/groups/getById",{id:b.id},function(b,c){c&&a.bbcForm.setModel(c)}),a.save=function(b){a.form&&(a.form.errors={});var d=b._id?"groups/groups/update":"groups/groups/create";f.emit(e+d,b,function(d,e){e?(a.bbcForm.setModel("object"==typeof e?e:b,!0),c.path("/admin/groups")):"ValidationError"===d.name&&a.bbcForm.populateValidation(a.form,d.errors)})},f.emit(e+"roles/roles/getAll",{options:{sort:{name:1},fields:["name","description"]}},function(b,c){c&&(a.roles=c.items)})}]),angular.module("admin.rights",[]).config(["$routeProvider",function(a){a.when("/admin/rights",{templateUrl:"app/admin/rights/rights.html",controller:"AdminRightListCtrl"})}]).controller("AdminRightListCtrl",["$scope","adminModulePath","$bbcTransport",function(a,b,c){a.initialPageSize=10,a.pagingOptions={skip:0,limit:a.initialPageSize},a.sortOpts={name:1};var d=function(){var d={options:a.pagingOptions};d.options.sort=a.sortOpts,c.emit(b+"rights/rights/getAll",d,function(b,c){c&&(a.rights=c.items,a.count=c.count)})};a.load=function(b,c){a.pagingOptions=c,a.sortOpts=b,d()},d()}]),angular.module("admin.roles",[]).config(["$routeProvider",function(a){a.when("/admin/roles",{templateUrl:"app/admin/roles/roles.html",controller:"AdminRoleListCtrl"}),a.when("/admin/roles/edit/:id",{templateUrl:"app/admin/roles/editRole.html",controller:"AdminEditRoleCtrl",resolve:{rights:["srvLibrary",function(a){return a.getRights()}]}}),a.when("/admin/roles/new",{templateUrl:"app/admin/roles/editRole.html",controller:"AdminEditRoleCtrl",resolve:{rights:["srvLibrary",function(a){return a.getRights()}]}})}]).factory("srvLibrary",["$q","$bbcTransport","adminModulePath",function(a,b,c){var d={getRights:function(){var d=a.defer();return b.emit(c+"rights/rights/getAll",function(a,b){d.resolve(b.items)}),d.promise}};return d}]).controller("AdminRoleListCtrl",["$rootScope","$scope","adminModulePath","$bbcTransport","$bbcModal","$translate",function(a,b,c,d,e,f){b.initialPageSize=10,b.pagingOptions={skip:0,limit:b.initialPageSize},b.sortOpts={name:1};var g="DEL",h="DEL",i={yes:"Y",no:"N"};a.$on("$translateChangeSuccess",function(){f(["DELETE","DELETE_MSG","YES","NO"]).then(function(a){g=a.DELETE,h=a.DELETE_MSG,i.yes=a.YES,i.no=a.NO})});var j=function(){var a={options:b.pagingOptions};a.options.sort=b.sortOpts,a.options.fields=["name","description"],d.emit(c+"roles/roles/getAll",a,function(a,c){if(c){for(var d=0;d<c.items.length;d++){var e=c.items[d].name.toLowerCase();c.items[d].canDelete="user"!==e&&"guest"!==e&&"admin"!==e}b.roles=c.items,b.count=c.count}})};a.$broadcast("$translateChangeSuccess"),b.load=function(a,c){b.pagingOptions=c,b.sortOpts=a,j()},b.closeAlert=function(a){b.alerts.splice(a,1)},b.alerts=[],b.remove=function(a){b.alerts.length=0;var f={id:"deleteGroup",message:h,headline:g,backdrop:!0,buttonTextValues:i};f.callObj={cbYes:function(){d.emit(c+"roles/roles/remove",{id:a},function(a){a?"ControllerError"===a.name?b.alerts.push({type:"danger",msg:a.message}):b.alerts.push({type:"danger",msg:"GENERIC_ERROR"}):j()})},cbNo:function(){}},e.open(f)},j()}]).controller("AdminEditRoleCtrl",["$scope","$routeParams","$location","$bbcForm","adminModulePath","$bbcTransport","rights",function(a,b,c,d,e,f,g){function h(){a.isReadOnly="User"===a.bbcForm.model.name||"Guest"===a.bbcForm.model.name||"Admin"===a.bbcForm.model.name;for(var b=0;b<a.rights.length;b++){var c=a.rights[b];c.checked=i(c._id),c.sort=c.checked}}function i(b){if(a.bbcForm.model.rights)for(var c=0;c<a.bbcForm.model.rights.length;c++)if(a.bbcForm.model.rights[c]===b)return!0;return!1}a.bbcForm=d("baboon_role","_id"),a.isReadOnly=!1,a.rights=g,b.id&&!a.bbcForm.hasLoadedModelFromCache(b.id)?f.emit(e+"roles/roles/getById",{id:b.id},function(b,c){c&&(a.bbcForm.setModel(c),h())}):h(),a.setStyle=function(a){return a.checked===!0?{"border-left":"3px solid green"}:null},a.save=function(b){a.form&&(a.form.errors={});var d=b._id?"roles/roles/update":"roles/roles/create";f.emit(e+d,b,function(d,e){e?(a.bbcForm.setModel("object"==typeof e?e:b,!0),c.path("/admin/roles")):d&&"ValidationError"===d.name&&a.bbcForm.populateValidation(a.form,d.errors)})}}]),angular.module("admin.users",[]).config(["$routeProvider",function(a){a.when("/admin/users",{templateUrl:"app/admin/users/users.html",controller:"AdminUserListCtrl"}),a.when("/admin/users/edit/:id",{templateUrl:"app/admin/users/editUser.html",controller:"AdminEditUserCtrl"}),a.when("/admin/users/new",{templateUrl:"app/admin/users/editUser.html",controller:"AdminEditUserCtrl"})}]).controller("AdminUserListCtrl",["$scope","adminModulePath","$bbcTransport","$bbcModal","$translate","$rootScope",function(a,b,c,d,e,f){a.initialPageSize=10,a.pagingOptions={skip:0,limit:a.initialPageSize},a.sortOpts={name:1};var g="DEL",h="DEL",i={yes:"Y",no:"N"};f.$on("$translateChangeSuccess",function(){j()});var j=function(){e(["DELETE_USER","DELETE_USER_MSG","YES","NO"]).then(function(a){g=a.DELETE_USER,h=a.DELETE_USER_MSG,i.yes=a.YES,i.no=a.NO})},k=function(){var d={options:a.pagingOptions};d.options.sort=a.sortOpts,d.options.fields=["name","email","is_active"],c.emit(b+"users/users/getAll",d,function(b,c){if(c){for(var d=0;d<c.items.length;d++){var e=c.items[d].name.toLowerCase();c.items[d].canDelete="guest"!==e}a.users=c.items,a.count=c.count}})};j(),a.load=function(b,c){a.pagingOptions=c,a.sortOpts=b,k()},a.closeAlert=function(b){a.alerts.splice(b,1)},a.alerts=[],a.remove=function(e,f){a.alerts.length=0,g=g+" "+f;var j={id:"deleteUser",message:h,headline:g,backdrop:!0,buttonTextValues:i};j.callObj={cbYes:function(){c.emit(b+"users/users/remove",{id:e},function(b){b?"ControllerError"===b.name?a.alerts.push({type:"danger",msg:b.message}):a.alerts.push({type:"danger",msg:"GENERIC_ERROR"}):k()})},cbNo:function(){}},d.open(j)},k()}]).controller("AdminEditUserCtrl",["$scope","$routeParams","$location","$bbcForm","$bbcTransport","$log","adminModulePath",function(a,b,c,d,e,f,g){function h(){for(var b=0;a.rights&&b<a.rights.length;b++)a.rights[b].sort=a.rights[b].isSelected}function i(){var b=[],c=[];angular.forEach(a.bbcForm.model.groups,function(c){angular.forEach(a.groups,function(a){return c===a._id?(b=b.concat(a.roles),!1):void 0})}),b=b.concat(a.bbcForm.model.roles);for(var d,e=0;e<b.length;e++){d=!1;for(var f=0;f<c.length;f++)b[e]===c[f]&&(d=!0);d||c.push(b[e])}var g=[];return angular.forEach(c,function(b){angular.forEach(a.roles,function(a){return b===a._id?(g.push(a),!1):void 0})}),g}function j(){a.bbcForm.model.rights=a.bbcForm.model.rights||[],a.bbcForm.model.roles=a.bbcForm.model.roles||[],a.bbcForm.model.groups=a.bbcForm.model.groups||[];var b=i(),c=a.rights,d=a.bbcForm.model.rights;angular.isArray(c)&&angular.forEach(c,function(a){a.source=[],a.isSelected=!1,angular.forEach(b,function(b){angular.forEach(b.rights,function(c){return a._id===c?(a.source.push(b.name),a.isSelected=!0,!1):void 0})}),angular.forEach(d,function(b){return a._id===b._id?(a.isSelected=b.hasAccess,!1):void 0})}),h()}a.bbcForm=d("baboon_right","_id"),a.languages=[{key:"GERMAN",value:"de-de"},{key:"ENGLISH",value:"en-us"}],a.isPasswordConfirmed=function(){return a.bbcForm.model.password===a.bbcForm.model.confirmed_password},a.save=function(b){a.form&&(a.form.errors={});var d=function(d,e){e?(a.bbcForm.setModel("object"==typeof e?e:b,!0),c.path("/admin/users")):d&&("ValidationError"===d.name?a.bbcForm.populateValidation(a.form,d.errors):f.log(d))};b._id?e.emit(g+"users/users/update",b,d):e.emit(g+"users/users/create",b,d)},a.setRight=function(b){var c=function(a){return a._id},d=a.bbcForm.model.rights.map(c).indexOf(b._id);b.source.length>0&&b.isSelected||b.source.length<=0&&!b.isSelected?d>-1&&a.bbcForm.model.rights.splice(d,1):d>-1?a.bbcForm.model.rights[d].hasAccess=b.isSelected:a.bbcForm.model.rights.push({_id:b._id,hasAccess:b.isSelected})},a.setListItemStyle=function(a){return a.isSelected?{"border-left":"3px solid green"}:null},a.reset=function(b){a.bbcForm.reset(b),j()},e.emit(g+"users/users/getUserData",{id:b.id},function(c,d){if(d)if(a.groups=d.groups||[],a.roles=d.roles||[],a.rights=d.rights||[],a.bbcForm.hasLoadedModelFromCache(b.id)){a.bbcForm.model.groups=[],a.bbcForm.model.roles=[],a.bbcForm.model.rights=[];var e=["User","Guest"];angular.forEach(a.roles,function(b){e.indexOf(b.name)>-1&&a.bbcForm.model.roles.push(b._id)}),a.bbcForm.setModel(a.bbcForm.model)}else delete d.user.register_date,"guest"===d.user.name&&(d.user.isGuest=!0),a.bbcForm.setModel(d.user);a.$watchCollection("bbcForm.model.roles",function(){j()}),a.$watchCollection("bbcForm.model.groups",function(){j()})})}]);